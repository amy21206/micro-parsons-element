<!DOCTYPE html>
<html>
<head>
<script src="skulpt.min.js" type="text/javascript"></script>
<script src="skulpt-stdlib.js" type="text/javascript"></script>
<script src="codemirror.js"></script>
<script src="mode/python/python.js"></script>
<link rel="stylesheet" href="xcode.css">
<link rel="stylesheet" href="demo.css">
<link rel="stylesheet" href="codemirror.css">
<link rel="stylesheet" href="./micro-parsons/micro-parsons.css">

<!-- material design UI -->
<link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
</head>

<body>

<script type="module">
import "./micro-parsons/micro-parsons.js";
</script>

<h3>Sample Problem</h3>
<div>
	Write a function sum13(nums) to return the sum of the numbers in the list nums, returning 0 for an empty list. Except the number 13 is very unlucky, so it does not count and a number that comes immediately after a 13 also does not count.  For example, sum13([13,2]) returns 0, sum13([1, 13, 4, 2])  returns 3, sum13([1, 2, 3])  returns 6.
</div>
<br>

<div class="options">

    <div>
        <button class="mdc-button mdc-button--raised mdc-button--leading" id="run-btn">
            <span class="mdc-button__ripple"></span>
            <!-- <i class="material-icons mdc-button__icon" aria-hidden="true">playarrow</i> -->
            <span class="material-symbols-outlined">
                play_arrow
                </span>
            <span class="mdc-button__label"> Run</span>
        </button>
    </div>

    <div>
        <button class="mdc-button mdc-button--raised mdc-button--leading" id="help-btn">
            <span class="mdc-button__ripple"></span>
            <!-- <i class="material-icons mdc-button__icon" aria-hidden="true">playarrow</i> -->
            <span class="material-symbols-outlined">
                help
                </span>
            <span class="mdc-button__label">Help</span>
        </button>
    </div>

    <!-- difficulty bar: hidden, just as a state holder -->
    <!-- 1 is easiest (micro parsons), 2 is provide subgoal, 3 is no help -->
    <input style="display:none;" type="range" min="1" max="3" id="scaffolding-slider" value="3">

    <div class="difficulty-vis-container">
        <div class="difficulty-vis-label">
            Difficulty:
        </div>
        <div class="difficulty-vis">
            <span class="material-symbols-outlined" data-difficulty="1">
                signal_cellular_alt_1_bar
                </span>
            <span class="material-symbols-outlined" data-difficulty="2">
                signal_cellular_alt_2_bar
                </span>
            <span class="material-symbols-outlined" data-difficulty="3">
                signal_cellular_alt
                </span>
        </div>
    </div>

</div>

<!-- <button style="
    margin-left: 40px;
    margin-bottom: 15px;
" id="run-btn">Run</button> -->


<textarea class="subgoal" id="write-code" style="width: 870px; height: 350px; overflow: scroll; white-space: pre; font-family: monospace;font-size: 15px;padding: 10px;" spellcheck="false"></textarea>

<micro-parsons language="python" id="micro-parsons-pseudo">
<mp-context subgoal>
# Subgoal 1: Define function and initialize variables.
def sum13(sums):
    total = 0
    <mp-line randomize indentation="1">
    <mp-block>found_13</mp-block>
    <mp-block>=</mp-block>
    <mp-block>False</mp-block>
    <mp-block distractor>True</mp-block>
    <mp-block distractor>false</mp-block>
    </mp-line>
</mp-context>
    <mp-context subgoal>
    # Subgoal 2: Start a loop to examine each number in the list.
    for num in nums:
    </mp-context>
        <mp-context subgoal>
        # Subgoal 3: Within the loop, handle the case for the number following 13.
        if found_13:
            found_13 = False
        </mp-context>
        <mp-context subgoal>
        # Subgoal 4: Handle the case for encountering a 13 in the list.
        <mp-line randomize indentation="2">
        <mp-block>==<mp-block-ttp>equals</mp-block-ttp></mp-block>
        <mp-block>else</mp-block>
        <mp-block>num</mp-block>
        <mp-block>:</mp-block>
        <mp-block>13</mp-block>
        <mp-block>elif</mp-block>
        <mp-block distractor>!=</mp-block>
        </mp-line>
            found_13 = True
        </mp-context>
        <mp-context subgoal subgoal-line-count="2">
        # Subgoal 5: Finally, handle the case for encountering a number that
        # isn't 13 or doesn't follow a 13.
        else:
            total += num
        </mp-context>
    <mp-context subgoal>
    # Subgoal 6: Return the accumulated total after the loop ends.
    return total
    </mp-context>
</micro-parsons>

<div class="output-div">
    Output: 
    <br>
    <pre id="output" class="output-pre"></pre>
</div>

</body>

</html>

<script>
//initializing material UI
mdc.ripple.MDCRipple.attachTo(document.querySelector('#run-btn'));
</script>

<script>

// This function visualizes the current difficulty by changing the icon displayed.
// value: string, '1', '2', or '3'
function visualizeDifficulty(value) {
    var visDiv = document.querySelector('.difficulty-vis');
    for (const iconSpan of visDiv.children) {
        if (iconSpan.dataset.difficulty == value) {
            iconSpan.style.display = '';
        } else {
            iconSpan.style.display = 'none';
        }
    }
}

function helpBtnOnClick() {
    let slider = document.querySelector('#scaffolding-slider');
    slider.value = (slider.value - 1).toString();
    slider.oninput();
}
document.querySelector('#help-btn').onclick = () => helpBtnOnClick();

var context = document.querySelector('mp-line').parentElement;
while (context.tagName == 'MP-CONTEXT') {
	if (context.firstChild.classList) {
		if (context.firstChild.classList.contains('subgoal')) {
			context.firstChild.click();	
		}

	}
	context = context.parentElement;
}

var slider = document.querySelector('#scaffolding-slider');
slider.oninput = function() {
	var value = this.value;
    // change difficulty vis
    visualizeDifficulty(value);
    // change current input mode
	if (value == '3') {
		document.querySelector('micro-parsons').style.display='none';
        document.getElementById('run-btn').style.visibility = '';
        document.getElementById('help-btn').style.visibility = '';
        // window.testEditor.display.wrapper.style.display = "block";
		//document.querySelector('#write-code').style.display='block';
		//document.querySelector('#write-code').value = `# Please write your code below`;
	} else if (value == '2') {
		document.querySelector('micro-parsons').style.display='none';
        window.testEditor.display.wrapper.style.display = "block";
        document.getElementById('run-btn').style.visibility = '';
        document.getElementById('help-btn').style.visibility = '';
		//document.querySelector('#write-code').style.display='block';
        const subgoalText = 
`# Subgoal 1: Define function and initialize variables.
def sum13(sums):
    total = 0
    found_13 = False
    # Subgoal 2: Start a loop to examine each number in the list.

        # Subgoal 3: Within the loop, handle the case for the number following 13.

        # Subgoal 4: Handle the case for encountering a 13 in the list.

        # Subgoal 5: Finally, handle the case for encountering a number that isn't 13 or doesn't follow a 13.

    # Subgoal 6: Return the accumulated total after the loop ends.

		`;
        testEditor.getDoc().setValue(subgoalText);
	} else if (value == '1') {
        // disable help button
		document.querySelector('micro-parsons').style.display='block';
		// document.querySelector('#write-code').style.display='none';
        window.testEditor.display.wrapper.style.display = "none";
        document.getElementById('run-btn').style.visibility = 'hidden';
        document.getElementById('help-btn').style.visibility = 'hidden';
        document.querySelector('.output-div').style.visibility = 'hidden';
        // see if user wrote code for each subgoal
        const subgoalReg = /# Subgoal .*\n/
        const split = testEditor.getValue().split(subgoalReg);
        // from value 1
        let subgoalWritten = [];
        if (split.length > 6) {
            for (let i = 1; i < split.length; ++i) {
                if (split[i].trim() != '') {
                    subgoalWritten.push(true);
                } else {
                    subgoalWritten.push(false);
                }
            }
        }
        // expand/collapse each subgoal
        for (let i = 0; i < subgoalWritten.length; ++i) {
            document.querySelector('micro-parsons').toggleSubgoalExpand(i, subgoalWritten[i]);
        }
	}
}
slider.oninput();

</script>

<script>
// this part of the script handles skulpt

// output function: appends the output text to the "output" pre
function outf(text) {
    let mypre = document.getElementById("output");
    mypre.innerHTML = mypre.innerHTML + text;
}
// took from Skulpt doc. I think it reads skulpt module.
function builtinRead(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
}

// also from Skulpt doc.
// Here's everything you need to run a python program in skulpt
// grab the code from your textarea
// get a reference to your pre element for output
// configure the output function
// call Sk.importMainWithBody()
function runit() { 
   var prog = testEditor.getValue(); 
   var mypre = document.getElementById("output"); 
   mypre.innerHTML = ''; 
   Sk.pre = "output";
   Sk.configure({output:outf, read:builtinRead}); 
//    (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';
   var myPromise = Sk.misceval.asyncToPromise(function() {
       return Sk.importMainWithBody("<stdin>", false, prog, true);
   });
   myPromise.then(function(mod) {
       console.log('success');
   },
       function(err) {
        mypre.innerHTML = mypre.innerHTML + `<span style="color: red;">${err.toString()}</span>`
       console.log(err.toString());
   });
} 

document.getElementById('run-btn').onclick = () => runit();

</script>


<script>
// This parti of the script handles codemirror
var myTextarea = document.getElementById('write-code');
var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true,
    indentUnit: 4,
    readOnly: false,
    mode: "python"
});
window.testEditor = editor;
testEditor.setValue("# Please write your code below\n\n\n\n\n")
</script>